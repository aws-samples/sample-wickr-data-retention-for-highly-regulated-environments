#!/usr/bin/env node
import * as cdk from 'aws-cdk-lib';
import { AwsSolutionsChecks, NagSuppressions, NIST80053R5Checks } from 'cdk-nag';
import { Aspects } from 'aws-cdk-lib';

import { WickrDRBPreReqStack } from '../lib/WickrDRB-PreReqStack';
import { WickrDRBStack } from '../lib/WickrDRB-Stack';

import config from './config';

const app = new cdk.App();
const env = {
  account: config.accountId,
  region: config.region
};
const { prefix } = config;

const prereq = new WickrDRBPreReqStack(app, 'WickrDRBPreReqStack', {
  stackName: `${prefix}-prereq-stack`,
  env,
  tags: config.tags
});

const bot = new WickrDRBStack(app, 'WickrDRBStack', {
  stackName: `${prefix}-bot-stack`,
  env,
  dataBucket: prereq.dataBucket,
  efs: prereq.efs,
  wickrSecret: prereq.wickrSecret,
  ecsConfigSecret: prereq.ecsConfigSecret,
  efsSG: prereq.efsSG,
  ecsSG: prereq.ecsSG,
  infraKey: prereq.infraKey,
  dataKey: prereq.dataKey,
  tags: config.tags
});

Aspects.of(app).add(new AwsSolutionsChecks({ verbose: true }));
Aspects.of(app).add(new NIST80053R5Checks({ verbose: true }));

NagSuppressions.addStackSuppressions(prereq, [
  { id: 'AwsSolutions-SMG4', reason: 'Secrets in this solution cannot be rotated automatically' },
  { id: 'NIST.800.53.R5-SecretsManagerRotationEnabled', reason: 'Secrets in this solution cannot be rotated automatically' },
  { id: 'NIST.800.53.R5-EFSInBackupPlan', reason: 'AWS Backup plan is out of scope of this solution' },
  { id: 'NIST.800.53.R5-S3BucketReplicationEnabled', reason: 'S3 cross-region replication is out of scope of this solution' },
  { id: 'NIST.800.53.R5-CloudWatchAlarmAction', reason: 'CloudWatch Actions are out of scope of this solution.' }
]);

NagSuppressions.addStackSuppressions(bot, [
  { id: 'NIST.800.53.R5-IAMNoInlinePolicy', reason: 'These are the default policies that are autogenerated from CDK' },
  { id: 'AwsSolutions-IAM4', reason: 'These are the default policies that are autogenerated from CDK' },
  { id: 'NIST.800.53.R5-LambdaDLQ', reason: 'This is not required because Lambda is ran once post stack create' },
  { id: 'AwsSolutions-IAM5', reason: 'These * policies are intentional and/or mitigated with conditional statements' }
]);
